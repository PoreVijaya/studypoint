{% extends 'school/adminbase.html' %}
{% block content %}

<h3 class="text-dark ms-2">View All Students</h3>

<div class="container my-4">

  <!-- FILTER & SEARCH -->
  <form method="get" class="row g-3 mb-3">

    <div class="col-auto">
      <label>Joining Month</label>
      <input type="month" name="month" class="form-control"
             value="{{ request.GET.month }}">
    </div>

    <div class="col-auto align-self-end">
      <button class="btn btn-primary">Filter</button>
      <a href="{% url 'admin-view-student' %}" class="btn btn-secondary">Reset</a>
    </div>

    <div class="col-auto ms-auto">
      <label>Search Name</label>
      <div class="input-group input-group-sm">
        <input type="text" name="search_name" class="form-control"
               value="{{ search_name }}" placeholder="Enter name">
        <span class="input-group-text" id="clear-search" style="cursor:pointer;">Ã—</span>
        <button class="btn btn-primary">Search</button>
      </div>
    </div>

  </form>

  <h5>Total Students: {{ total_count }}</h5>

  <!-- STUDENT TABLE -->
  <div class="card shadow p-3">
    <table class="table table-bordered table-striped">

      <thead class="table-primary">
        <tr>
          <th>Profile</th>
          <th>Name</th>
          <th>Joining Date</th>
          <th>Contact</th>
          <th>Vehicle</th>
          <th>Registered By</th>
          <th class="text-center">Actions</th>
        </tr>
      </thead>

      <tbody>
        {% for s in students %}
        <tr>

          <!-- Profile -->
          <td class="text-center">
            {% if s.profile_pic %}
              <img src="{{ s.profile_pic.url }}"
                   width="50" height="50"
                   style="border-radius:50%;">
            {% else %}
              <span class="text-muted">No Pic</span>
            {% endif %}
          </td>

          <!-- Student Name -->
          <td>{{ s.user.first_name }} {{ s.user.last_name }}</td>

          <!-- Joining Date -->
          <td>
            {% if s.payment_date %}
              {{ s.payment_date|date:"d M Y" }}
            {% else %}
              <span class="text-muted">-</span>
            {% endif %}
          </td>

          <!-- Contact -->
          <td>{{ s.mobile|default:"-" }}</td>

          <!-- Vehicle -->
          <td>{{ s.vehicle_number|default:"-" }}</td>

          <!-- Registered By -->
          <td>
            {% if s.collected_by %}
              {{ s.collected_by.first_name }} {{ s.collected_by.last_name }}
            {% else %}
              <span class="text-muted">Not Assigned</span>
            {% endif %}
          </td>

          <!-- Actions (ONLY FOR SAME ADMIN) -->
          <td class="text-center">
            {% if s.collected_by_id == request.user.id %}
              <a class="btn btn-sm btn-primary"
                 href="{% url 'update-student' s.id %}">
                <i class="fas fa-edit"></i>
              </a>
              <a class="btn btn-sm btn-danger"
                 href="{% url 'delete-student-from-school' s.id %}"
                 onclick="return confirm('Are you sure you want to delete this student?');">
                <i class="fas fa-trash"></i>
              </a>
            {% else %}
              <span class="text-muted">No Access</span>
            {% endif %}
          </td>

        </tr>
        {% empty %}
        <tr>
          <td colspan="7" class="text-center text-muted">
            No records found
          </td>
        </tr>
        {% endfor %}
      </tbody>

    </table>
  </div>
</div>

<script>
document.getElementById('clear-search').onclick = function () {
  document.querySelector('[name="search_name"]').value = '';
  this.closest('form').submit();
}
</script>

{% endblock %}
